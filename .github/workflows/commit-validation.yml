name: commit-validation
on: [ pull_request ]

jobs:
  check-commit-msg-length:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v1
    - name: Check commit message length
      run: |
        # Get last commit messages
        if [ "${{github.event_name}}" = "push" ]; then
          if [ "${{github.event.before}}" = "0000000000000000000000000000000000000000" ]; then
            LOG_BASE="${{github.event.commits[0].id}}^"
          else
            LOG_BASE="${{github.event.before}}"
          fi
        elif [ "${{github.event_name}}" = "pull_request" ]; then
          LOG_BASE="origin/${{github.base_ref}}"
        fi
        if [ -n "$LOG_BASE" ]; then
          if git log --no-merges --pretty=format:"%s" $LOG_BASE.. -- | grep -qE "^[^#].{78}"; then
            echo "Last commit log contains a line with more than 78 characters."
            exit 1
          else
            echo "Commit log looks good."
          fi
          unset LOG_BASE
        else
          echo "Not checking commits on ${{github.event_name}}"
        fi
